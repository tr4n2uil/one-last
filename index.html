<!DOCTYPE html>
<!--
/**
 *  one-last HTML file
 *
 *  Vibhaj Rajan <vibhaj8@gmail.com>
 *  2014 Facebook labs <http://vibhaj.com/labs/>
 *
 *  Licensed under MIT License 
 *  http://www.opensource.org/licenses/mit-license.php
 *
**/
-->

<html>
    <head>
        <title>one-last</title>
        <link rel='stylesheet', href='//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css' >
        <style type="text/css">
            .round {
                border-radius: 1em;
                -moz-border-radius: 1em;
                -webkit-border-radius: 1em;
                width: 2em;
            }
            .status {
                margin: 35px 0;
            }
        </style>
        <script type='text/javascript' src='//code.jquery.com/jquery-1.10.2.min.js'></script>
        <script type='text/javascript' src='//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js'></script>
        <script type='text/javascript' src='//connect.facebook.net/en_US/all.js'></script>
        <script type="text/javascript" src="//timeago.yarp.com/jquery.timeago.js"></script>
    </head>

    <body style="padding: 0 25px; margin-left: 85px;">
        <div id="fb-root"></div>
        <h1><a href="/bitbucket/one-last/index.html" style="color: black"><strong>one-last</strong></a><div class="pull-right text-right"><fb:login-button autologoutlink="true" show-faces="true" width="200" max-rows="1" perms="email,read_stream,user_about_me,user_friends,user_likes,friends_status,friends_photos"></fb:login-button></div></h1>

        <div style="width: 600px; margin-top: 25px;">
            <ul class="nav nav-tabs" style="margin-bottom: 25px;">
                <li class="menu active" id="view-status"><a href="#" onclick="$('.menu').removeClass('active');$('#view-status').addClass('active'); UI.render('posts'); return false;">Status</a></li>
                <li class="menu" id="view-photo"><a href="#" onclick="$('.menu').removeClass('active');$('#view-photo').addClass('active'); UI.render('photos'); return false;">Photos</a></li>
                <li class="menu" id="view-pages"><a href="#" onclick="$('.menu').removeClass('active');$('#view-pages').addClass('active'); UI.render('pages'); return false;">Pages</a></li>
            </ul>

            <div id="main-ui"></div>
            <div id="signal-ui" style="padding: 1em 4.5em;"></div>
        </div>
    </body>

    <script type="text/javascript">
        $( document ).ready(function(){

            UI = {
                canvas: $( '#main-ui' ),
                signal: $( '#signal-ui' ),
                friends: {},
                queue: [],
                done: 0,
                map: {},
                processing: false,

                query: {
                    stream: 'select description, message, type, source_id, post_id, action_links from stream where source_id in (select uid2 from friend where uid1=me()) order by created_time desc limit 150',
                    status: { 
                        start: 'select message, status_id, uid, time from status where uid in (select uid2 from friend where uid1=me() and not ( uid2 in (',
                        end: '))) order by time desc limit 15 offset '
                    },
                    photo: {
                        start: 'select object_id, caption, link, src, src_big, owner, created from photo where owner in (select uid2 from friend where uid1=me() and not ( uid2 in (',
                        end: '))) order by created desc limit 15 offset ',
                    },
                    pages: {
                        start: 'SELECT post_id, actor_id, target_id, message, created_time FROM stream WHERE filter_key in (SELECT filter_key FROM stream_filter WHERE uid = me() AND type = "application") and not (actor_id in (',
                        end: ')) order by created_time desc limit 15 offset '
                    },
                    link: 'select link_id, url, title, summary, owner from link where owner in (select uid2 from friend where uid1=me()) order by created_time desc limit 150',
                    video: 'select vid, description, embed_html, link, title, owner from video where owner in (select uid2 from friend where uid1=me()) order by created_time desc limit 150'
                },

                process: function(next){
                    var that = this;
                    if(this.queue.length && this.done){
                        next(this.queue.pop(), function(){
                            that.done--;
                            that.process(next);
                        });
                    }
                    else if(this.queue.length) {
                        that.processing = false;
                        that.scroll(function(){
                            that.done = 15;
                            that.process(next);
                        });
                    }
                    else {
                        that.processing = false;
                        that.scroll();
                    }
                },

                clean: function(){
                    this.friends = {};
                    this.queue = [];
                    this.done = 0;
                    this.map = {};
                    this.processing = false;
                    this.canvas.html('');
                },

                render: function(type){
                    var type = type || 'posts';
                    var that = this;
                    that.clean();

                    if(type == 'pages'){
                        var query = 'select page_id, name from page where page_id in (select page_id from page_fan where uid=me())'
                        var item = 'Likes';
                    }
                    else {
                        var query = 'select uid, username, name, status from user where uid in (select uid2 from friend where uid1=me()) order by status.time desc';
                        var item = 'Friends';
                    }
                    that.signal.html('Getting '+item+' ...');

                    FB.api({
                            method: 'fql.query',
                            query: query
                        }, function(response) {
                        that.signal.html('Processing '+item+' ...');
                        //console.log(response);
                        for( var i in response ){
                            if(type == 'pages'){
                                that.friends[ response[i].page_id ] = response[i];
                            }
                            else {
                                that.friends[ response[i].uid ] = response[i];    
                            }
                            //that.queue.push(response[i]);
                        }
                        //that.queue.reverse();
                        that.signal.html('');
                        if(type == 'posts'){
                            that.posts(that.canvas);    
                        }
                        else if(type == 'photos'){
                            that.photos(that.canvas);
                        }
                        else if(type == 'pages'){
                            that.pages(that.canvas);
                        }
                    });
                },

                scroll: function(callback){
                    var that = this;
                    jQuery( document ).unbind( 'scroll' );
                    
                    if( callback ){
                        jQuery( document ).bind( 'scroll', function( e ){
                            if ( that.processing || false )
                                return false;

                            if ( $( window ).scrollTop() >= $( document ).height() - $( window ).height() - 500 ){
                                that.processing = true;
                                callback();
                            }
                        } );

                        if ( $( window ).scrollTop() >= $( document ).height() - $( window ).height() - 500 ){
                            that.processing = true;
                            callback();
                        }
                    }
                },

                photos: function(canvas){
                    var that = this;
                    that.scroll();
                    that.signal.html('Getting Photos ...');
                    that.processing = false;

                    FB.api({
                        method: 'fql.query',
                        query: that.query.photo.start + Object.keys(that.map).join(',') + that.query.photo.end + that.done
                    }, function(response){
                        that.signal.html('Processing Photos ...');
                        console.log(response);

                        for(var i in response){
                            var status = response[i];
                            var f=that.friends[status.owner];
                            if(!(status.owner in that.map) && status.src_big){
                                that.map[status.owner] = 1;
                                var d = new Date(Number(status.created)*1000);

                                canvas.append('<div class="status" id="photo-'+status.object_id+'"><div class="pull-left" style="font-size: 2em; width: 2em;"><img src="//graph.facebook.com/'+status.owner+'/picture"></div><div style="margin-left: 4.5em;"><a href="//facebook.com/'+f.username+'/" target="_blank"><strong>'+f.name+'</strong></a><div style="margin-bottom: 8px;"><img src="'+status.src_big+'" style="max-width: 100%; max-height: 25em;"/></div>'+((status.caption && status.caption.length < 250) ? '<div style="margin-bottom: 8px;">'+status.caption+'</div>' : '')+'<div style="color: #999; font-size: 0.8em;">'+$.timeago(d)+'</div></div><div style="clear: both;"></div></div>');
                                //console.log(that.friends[status.uid].name, status.message);   
                            }
                        }

                        that.signal.html('');

                        if(response.length){
                            that.scroll(function(){
                                that.done += 15;
                                that.photos(canvas);
                            });
                        }
                    });
                },

                posts: function(canvas){
                    var that = this;
                    that.scroll();
                    that.signal.html('Getting Statuses ...');
                    that.processing = false;

                    FB.api({
                        method: 'fql.query',
                        query: that.query.status.start + Object.keys(that.map).join(',') + that.query.status.end + that.done
                    }, function(response){
                        that.signal.html('Processing Statuses ...');
                        console.log(response);
                        
                        for(var i in response){
                            var status = response[i];
                            if( !(status.uid in that.map) && status.message && status.message.length < 1500 ){
                                var f=that.friends[status.uid];
                                that.map[status.uid] = 1;
                                var d = new Date(Number(status.time)*1000);
                                canvas.append('<div class="status" id="status-'+status.uid+'"><div class="pull-left" style="font-size: 2em; width: 2em;"><img src="//graph.facebook.com/'+status.uid+'/picture"></div><div style="margin-left: 4.5em;"><a href="//facebook.com/'+f.username+'/" target="_blank"><strong>'+f.name+'</strong></a><div style="margin-bottom: 8px;">'+status.message.replace( /\n/g, '<br />')+'</div><div style="color: #999; font-size: 0.8em;">'+$.timeago(d)+'</div></div><div style="clear: both;"></div></div>');
                                //console.log(that.friends[status.uid].name, status.message);
                            }
                        }

                        that.signal.html('');

                        if(response.length){
                            that.scroll(function(){
                                that.done += 15;
                                that.posts(canvas);
                            });    
                        }
                    });
                },

                pages: function(canvas){
                    var that = this;
                    that.scroll();
                    that.signal.html('Getting Statuses ...');
                    that.processing = false;

                    FB.api({
                        method: 'fql.query',
                        query: that.query.pages.start + Object.keys(that.map).join(',') + that.query.pages.end + that.done
                    }, function(response){
                        that.signal.html('Processing Statuses ...');
                        console.log(response);
                        
                        for(var i in response){
                            var status = response[i];
                            if( !(status.actor_id in that.map) && status.actor_id in that.friends && status.message && status.message.length < 1500 ){
                                var f=that.friends[status.actor_id];
                                that.map[status.actor_id] = 1;
                                var d = new Date(Number(status.created_time)*1000);
                                canvas.append('<div class="status" id="status-'+status.actor_id+'"><div class="pull-left" style="font-size: 2em; width: 2em;"><img src="//graph.facebook.com/'+status.actor_id+'/picture"></div><div style="margin-left: 4.5em;"><a href="//facebook.com/'+status.actor_id+'/" target="_blank"><strong>'+f.name+'</strong></a><div style="margin-bottom: 8px;">'+status.message.replace( /\n/g, '<br />')+'</div><div style="color: #999; font-size: 0.8em;">'+$.timeago(d)+'</div></div><div style="clear: both;"></div></div>');
                                //console.log(that.friends[status.uid].name, status.message);
                            }
                        }

                        that.signal.html('');

                        if(response.length){
                            that.scroll(function(){
                                that.done += 15;
                                that.pages(canvas);
                            });    
                        }
                    });
                }

            }

            // init the FB JS SDK
            FB.init({
                appId      : '289641444493947',
                status     : true,
                xfbml      : true
            });

            FB.Event.subscribe('auth.authResponseChange', function(response) {
                if (response.status === 'connected') {
                    testAPI(response);
                    UI.render();
                //} else if (response.status === 'not_authorized') {
                //    FB.login(function(){}, {scope: 'email, user_about_me, user_friends'});
                // FB.api({ method: 'Auth.revokeAuthorization' }
                } else {
                    UI.clean();
                    //FB.login(cb, {scope: 'email,read_stream,user_about_me,user_friends'});
                }
            });
        });
    </script>
</html>
